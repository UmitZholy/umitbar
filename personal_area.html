<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>–õ–∏—á–Ω—ã–π —É–≥–æ–ª–æ–∫</title>
  <style>
    * {
      box-sizing: border-box;
    }
    html, body {
      margin: 0;
      padding: 0;
      width: 100%;
      height: 100%;
      background-color: #f2f2f2;
      font-family: 'Segoe UI', sans-serif;
      color: #333;
      overflow-x: hidden;
    }
    .container {
      display: flex;
      flex-direction: row;
      min-height: 100vh;
      flex-wrap: wrap;
    }
    .main {
      flex: 2;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 40px;
      background-color: #ffffff;
      width: 100%;
    }
    .main h1 {
      font-size: 2.4em;
      color: #2b2d42;
      margin: 0;
      text-align: center;
    }
    .welcome {
      font-size: 1.2em;
      margin-bottom: 30px;
      color: #555;
      text-align: center;
    }
    .main p {
      font-size: 18px;
      max-width: 600px;
      text-align: center;
      margin-top: 0;
      line-height: 1.6;
    }
    .sidebar {
      flex: 1;
      padding: 30px;
      background-color: #f9f9f9;
      border-left: 2px solid #ddd;
      display: flex;
      flex-direction: column;
      width: 100%;
    }
    .sidebar h2 {
      margin-top: 0;
      color: #2b2d42;
    }
    #noteInput {
      width: 100%;
      height: 80px;
      margin-bottom: 10px;
      padding: 10px;
      border-radius: 8px;
      border: 1px solid #ccc;
      font-size: 15px;
    }
    #addNote {
      padding: 10px;
      background-color: #8ecae6;
      color: white;
      border: none;
      border-radius: 8px;
      font-weight: bold;
      cursor: pointer;
    }
    #addNote:hover {
      background-color: #6bbbd7;
    }
    .note {
      background-color: #ffffff;
      border: 1px solid #ccc;
      border-radius: 8px;
      padding: 10px;
      margin: 8px 0;
      font-size: 14px;
      position: relative;
    }
    .note button {
      position: absolute;
      top: 5px;
      right: 8px;
      background: none;
      border: none;
      color: #888;
      cursor: pointer;
      font-weight: bold;
    }
    #clearNotes {
      margin-top: 10px;
      padding: 8px;
      background-color: #e57373;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: bold;
    }
    #clearNotes:hover {
      background-color: #d45555;
    }
    #logout {
      margin-top: auto;
      padding: 10px;
      background-color: #ffa500;
      border: none;
      border-radius: 8px;
      color: white;
      font-weight: bold;
      cursor: pointer;
      transition: background-color 0.3s ease;
    }
    #logout:hover {
      background-color: #cc8400;
    }
    .instagram-link {
      margin-top: auto;
      padding-top: 30px;
      text-align: center;
      font-size: 14px;
      color: #666;
    }
    .instagram-link a {
      color: #4a90e2;
      text-decoration: none;
    }
    #cozyMode {
      margin-top: 20px;
      padding: 12px 24px;
      background-color: #a5c4d4;
      color: white;
      border: none;
      border-radius: 8px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }
    .achievements-container {
      margin-top: 15px;
      max-height: 200px;
      overflow-y: auto;
    }
    .achievement {
      background-color: #e8f5e9;
      border-left: 4px solid #4caf50;
      padding: 10px;
      margin: 8px 0;
      border-radius: 0 8px 8px 0;
      position: relative;
      animation: fadeIn 0.5s;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateX(-10px); }
      to { opacity: 1; transform: translateX(0); }
    }
    #achievementInput {
      width: 100%;
      height: 60px;
      margin: 10px 0;
      padding: 10px;
      border-radius: 8px;
      border: 1px solid #ccc;
      font-size: 15px;
    }
    #addAchievement {
      width: 100%;
      padding: 10px;
      background-color: #4caf50;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      margin-bottom: 15px;
    }
    .mood-tracker {
      margin: 25px 0;
      padding: 15px;
      background-color: rgba(255, 245, 245, 0.7);
      border-radius: 10px;
      text-align: center;
    }
    .mood-options {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin: 15px 0;
    }
    .mood-options button {
      font-size: 24px;
      background: none;
      border: none;
      cursor: pointer;
      padding: 10px;
      border-radius: 50%;
      transition: all 0.3s;
    }
    .mood-options button:hover {
      transform: scale(1.2);
      background-color: rgba(0, 0, 0, 0.05);
    }
    .mood-history {
      margin-top: 15px;
      padding: 10px;
      background-color: white;
      border-radius: 8px;
      min-height: 50px;
    }
    .mood-entry {
      background: white;
      padding: 10px;
      margin: 10px 0;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }
    .mood-entry span {
      display: block;
      margin-top: 5px;
      font-size: 14px;
      color: #666;
    }
    .mood-question {
      margin-top: 15px;
      padding: 15px;
      background-color: #fff;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .mood-question textarea {
      width: 100%;
      height: 80px;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 8px;
      margin-bottom: 10px;
      resize: none;
    }
    #saveMoodReason {
      padding: 8px 15px;
      background-color: #8e44ad;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
    }
    .hidden {
      display: none;
    }
    .mood-advice {
      margin-top: 10px;
      padding: 10px;
      border-radius: 8px;
      font-size: 14px;
    }
    .advice-happy { background-color: #e8f5e9; border-left: 3px solid #2ecc71; }
    .advice-calm { background-color: #e3f2fd; border-left: 3px solid #3498db; }
    .advice-neutral { background-color: #f5f5f5; border-left: 3px solid #9e9e9e; }
    .advice-sad { background-color: #fce4ec; border-left: 3px solid #e91e63; }
    .advice-angry { background-color: #ffebee; border-left: 3px solid #f44336; }
    .cozy-effect {
      position: fixed;
      pointer-events: none;
      z-index: 1000;
    }
    .leaf {
      position: absolute;
      font-size: 24px;
      animation: float 10s linear infinite;
    }
    @keyframes float {
      0% { transform: translateY(0) rotate(0deg); opacity: 0; }
      10% { opacity: 1; }
      90% { opacity: 1; }
      100% { transform: translateY(-100vh) rotate(360deg); opacity: 0; }
    }
    @media (min-width: 768px) {
      .main { width: 66%; }
      .sidebar { width: 34%; }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="main">
      <h1>–õ–∏—á–Ω—ã–π —É–≥–æ–ª–æ–∫ üå§</h1>
      <div class="welcome" id="welcomeMessage"></div>
      <p>–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å. –ó–¥–µ—Å—å –º–æ–∂–Ω–æ –ø—Ä–æ—Å—Ç–æ –±—ã—Ç—å.<br><br>
        –ò–Ω–æ–≥–¥–∞, —á—Ç–æ–±—ã –¥–≤–∏–≥–∞—Ç—å—Å—è –¥–∞–ª—å—à–µ, –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å—Å—è –Ω–∞ –º–≥–Ω–æ–≤–µ–Ω–∏–µ, –≤–¥–æ—Ö–Ω—É—Ç—å –≥–ª—É–±–∂–µ –∏ –Ω–∞–ø–æ–º–Ω–∏—Ç—å —Å–µ–±–µ, –∫—Ç–æ —Ç—ã –µ—Å—Ç—å.
      </p>
      
      <div class="mood-tracker">
        <h3>üåà –ö–∞–∫–æ–µ —É —Ç–µ–±—è –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ —Å–µ–≥–æ–¥–Ω—è?</h3>
        <div class="mood-options">
          <button data-mood="happy" title="–û—Ç–ª–∏—á–Ω–æ!">üòä</button>
          <button data-mood="calm" title="–°–ø–æ–∫–æ–π–Ω–æ">üòå</button>
          <button data-mood="neutral" title="–ù–µ–π—Ç—Ä–∞–ª—å–Ω–æ">üòê</button>
          <button data-mood="sad" title="–ì—Ä—É—Å—Ç–Ω–æ">üòî</button>
          <button data-mood="angry" title="–†–∞–∑–¥—Ä–∞–∂—ë–Ω">üò†</button>
        </div>
        <div id="moodQuestion" class="mood-question hidden">
          <textarea id="moodReason" placeholder="–†–∞—Å—Å–∫–∞–∂–∏ –ø–æ–¥—Ä–æ–±–Ω–µ–µ..."></textarea>
          <button id="saveMoodReason">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        </div>
        <div id="moodHistory" class="mood-history"></div>
      </div>
      
      <button id="cozyMode">üåø –í–∫–ª—é—á–∏—Ç—å —É—é—Ç–Ω—ã–π —Ä–µ–∂–∏–º</button>
    </div>
    
    <div class="sidebar">
      <h2>–¢–≤–æ–∏ –∑–∞–º–µ—Ç–∫–∏</h2>
      <textarea id="noteInput" placeholder="–ù–∞–ø–∏—à–∏ –Ω–æ–≤—É—é –∑–∞–º–µ—Ç–∫—É..."></textarea>
      <button id="addNote">‚ûï –î–æ–±–∞–≤–∏—Ç—å</button>
      <div id="notesList"></div>
      <button id="clearNotes">üóë –û—á–∏—Å—Ç–∏—Ç—å –≤—Å—ë</button>
      
      <h2>üìù –ú–æ–π –¥–Ω–µ–≤–Ω–∏–∫ –ø–æ–±–µ–¥</h2>
      <textarea id="achievementInput" placeholder="–ß—Ç–æ —Ö–æ—Ä–æ—à–µ–≥–æ –ø—Ä–æ–∏–∑–æ—à–ª–æ —Å–µ–≥–æ–¥–Ω—è?"></textarea>
      <button id="addAchievement">‚ú® –ó–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞—Ç—å –ø–æ–±–µ–¥—É</button>
      <div id="achievementsList" class="achievements-container"></div>
      
      <button id="logout">üö™ –í—ã–π—Ç–∏</button>
      <div class="instagram-link">
        –ï—Å—Ç—å –∏–¥–µ–∏? –ù–∞–ø–∏—à–∏—Ç–µ –Ω–∞–º: <a href="https://instagram.com/um1tbar" target="_blank">@um1tbar</a>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import { getFirestore, doc, getDoc, setDoc, updateDoc } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBswC85ThRbIW5wDQOHubt-XHR7SDZJ2Ug",
      authDomain: "umitbar-db.firebaseapp.com",
      projectId: "umitbar-db",
      storageBucket: "umitbar-db.appspot.com",
      messagingSenderId: "114233176038",
      appId: "1:114233176038:web:99edd2a497ca1b39a4b027"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // –≠–ª–µ–º–µ–Ω—Ç—ã –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
    const elements = {
      welcomeMessage: document.getElementById('welcomeMessage'),
      noteInput: document.getElementById('noteInput'),
      addNote: document.getElementById('addNote'),
      notesList: document.getElementById('notesList'),
      clearNotes: document.getElementById('clearNotes'),
      logout: document.getElementById('logout'),
      cozyMode: document.getElementById('cozyMode'),
      achievementInput: document.getElementById('achievementInput'),
      addAchievement: document.getElementById('addAchievement'),
      achievementsList: document.getElementById('achievementsList'),
      moodTracker: document.querySelector('.mood-options'),
      moodQuestion: document.getElementById('moodQuestion'),
      moodReason: document.getElementById('moodReason'),
      saveMoodReason: document.getElementById('saveMoodReason'),
      moodHistory: document.getElementById('moodHistory')
    };

    // –î–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    let currentUser = localStorage.getItem('currentUser');
    if (!currentUser) window.location.href = 'index.html';
    const userDocRef = doc(db, "users", currentUser);
    elements.welcomeMessage.textContent = `–ü—Ä–∏–≤–µ—Ç, ${currentUser}!`;

    // –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
    const config = {
      moodIcons: { happy: 'üòä', calm: 'üòå', neutral: 'üòê', sad: 'üòî', angry: 'üò†' },
      moodQuestions: {
        happy: "–ß—Ç–æ —Å–µ–≥–æ–¥–Ω—è –ø—Ä–æ–∏–∑–æ—à–ª–æ —Ö–æ—Ä–æ—à–µ–≥–æ?",
        calm: "–ß—Ç–æ –ø–æ–º–æ–≥–ª–æ —É—Å–ø–æ–∫–æ–∏—Ç—å—Å—è?",
        neutral: "–û —á–µ–º –¥—É–º–∞–µ—à—å?",
        sad: "–ß—Ç–æ –æ–≥–æ—Ä—á–∏–ª–æ?",
        angry: "–ß—Ç–æ –≤—ã–∑–≤–∞–ª–æ –≥–Ω–µ–≤?"
      },
      moodAdvice: {
        happy: "–°–æ—Ö—Ä–∞–Ω–∏ —ç—Ç–æ —á—É–≤—Å—Ç–≤–æ!",
        calm: "–¶–µ–Ω–∏ –º–æ–º–µ–Ω—Ç—ã –ø–æ–∫–æ—è",
        neutral: "–í—Å—ë –≤ –ø–æ—Ä—è–¥–∫–µ",
        sad: "–≠—Ç–æ –ø—Ä–æ–π–¥–µ—Ç",
        angry: "–ü–æ–ø—Ä–æ–±—É–π –≥–ª—É–±–æ–∫–æ –ø–æ–¥—ã—à–∞—Ç—å"
      }
    };

    // –£—é—Ç–Ω—ã–π —Ä–µ–∂–∏–º
    let isCozyMode = localStorage.getItem('cozyMode') === 'true';
    const toggleCozyMode = () => {
      isCozyMode = !isCozyMode;
      localStorage.setItem('cozyMode', isCozyMode);
      document.body.style.backgroundColor = isCozyMode ? '#f5efe6' : '#f2f2f2';
      document.querySelector('.main').style.backgroundColor = isCozyMode ? '#f8f4ea' : '#ffffff';
      document.querySelector('.sidebar').style.backgroundColor = isCozyMode ? '#f0e9dd' : '#f9f9f9';
      elements.cozyMode.textContent = isCozyMode ? 'üåô –£—é—Ç–Ω—ã–π —Ä–µ–∂–∏–º' : 'üåø –í–∫–ª—é—á–∏—Ç—å —É—é—Ç';
      if (isCozyMode) addFallingElements();
      else document.querySelectorAll('.cozy-effect').forEach(el => el.remove());
    };

    // –ó–∞–º–µ—Ç–∫–∏
    const notesHandler = {
      async load() {
        elements.notesList.innerHTML = '';
        const docSnap = await getDoc(userDocRef);
        if (docSnap.exists()) {
          docSnap.data().notes?.forEach((note, idx) => {
            const div = document.createElement('div');
            div.className = 'note';
            div.innerHTML = `${note}<button onclick="notesHandler.delete(${idx})">√ó</button>`;
            elements.notesList.appendChild(div);
          });
        }
      },
      async add() {
        const value = elements.noteInput.value.trim();
        if (!value) return;
        const docSnap = await getDoc(userDocRef);
        const notes = docSnap.exists() ? docSnap.data().notes || [] : [];
        if (notes.length >= 20) return alert('–ú–∞–∫—Å–∏–º—É–º 20 –∑–∞–º–µ—Ç–æ–∫');
        await setDoc(userDocRef, { notes: [...notes, value] }, { merge: true });
        elements.noteInput.value = '';
        this.load();
      },
      async delete(index) {
        if (!confirm("–£–¥–∞–ª–∏—Ç—å –∑–∞–º–µ—Ç–∫—É?")) return;
        const docSnap = await getDoc(userDocRef);
        const notes = docSnap.data().notes;
        notes.splice(index, 1);
        await updateDoc(userDocRef, { notes });
        this.load();
      },
      async clear() {
        if (!confirm("–û—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ –∑–∞–º–µ—Ç–∫–∏?")) return;
        await updateDoc(userDocRef, { notes: [] });
        this.load();
      }
    };

    // –î–æ—Å—Ç–∏–∂–µ–Ω–∏—è
    const achievementsHandler = {
      async load() {
        elements.achievementsList.innerHTML = '';
        const docSnap = await getDoc(userDocRef);
        if (docSnap.exists()) {
          docSnap.data().achievements?.forEach((item, idx) => {
            const div = document.createElement('div');
            div.className = 'achievement';
            div.innerHTML = `
              <strong>${item.date}</strong><br>
              ${item.text}
              <button onclick="achievementsHandler.delete(${idx})">√ó</button>
            `;
            elements.achievementsList.appendChild(div);
          });
        }
      },
      async add() {
        const text = elements.achievementInput.value.trim();
        if (!text) return;
        const docSnap = await getDoc(userDocRef);
        const achievements = docSnap.exists() ? docSnap.data().achievements || [] : [];
        achievements.unshift({ text, date: new Date().toLocaleDateString() });
        await setDoc(userDocRef, { achievements }, { merge: true });
        elements.achievementInput.value = '';
        this.load();
      },
      async delete(index) {
        if (!confirm("–£–¥–∞–ª–∏—Ç—å –∑–∞–ø–∏—Å—å?")) return;
        const docSnap = await getDoc(userDocRef);
        const achievements = docSnap.data().achievements;
        achievements.splice(index, 1);
        await updateDoc(userDocRef, { achievements });
        this.load();
      }
    };

    // –ù–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ
    const moodHandler = {
      async save(mood, reason) {
        const today = new Date().toLocaleDateString();
        const docSnap = await getDoc(userDocRef);
        let moodData = docSnap.exists() ? docSnap.data().moodData || {} : {};
        if (!moodData[today]) moodData[today] = [];
        moodData[today].push({ mood, reason, timestamp: Date.now() });
        await updateDoc(userDocRef, { moodData });
        this.showHistory(moodData);
      },
      async showHistory(moodData) {
        const dates = Object.keys(moodData).sort().reverse().slice(0, 7);
        elements.moodHistory.innerHTML = dates.map(date => `
          <div class="mood-day">
            <strong>${date}</strong>
            ${moodData[date].map(entry => `
              <div class="mood-entry">
                ${config.moodIcons[entry.mood]}
                <span>${entry.reason}</span>
              </div>
            `).join('')}
          </div>
        `).join('');
      },
      showAdvice(mood) {
        const advice = document.createElement('div');
        advice.className = `mood-advice advice-${mood}`;
        advice.textContent = config.moodAdvice[mood];
        document.querySelector('.mood-advice')?.remove();
        elements.moodQuestion.after(advice);
      }
    };

    // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
    const addFallingElements = () => {
      for (let i = 0; i < 15; i++) {
        setTimeout(() => {
          const leaf = document.createElement('div');
          leaf.className = 'cozy-effect leaf';
          leaf.innerHTML = 'üçÇ';
          leaf.style.cssText = `
            left: ${Math.random() * 100}vw;
            animation-duration: ${5 + Math.random() * 10}s;
            animation-delay: ${Math.random() * 5}s;
          `;
          document.body.appendChild(leaf);
          setTimeout(() => leaf.remove(), 15000);
        }, i * 300);
      }
    };

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
    window.addEventListener('load', async () => {
      if (isCozyMode) toggleCozyMode();
      notesHandler.load();
      achievementsHandler.load();
      const docSnap = await getDoc(userDocRef);
      if (docSnap.exists() && docSnap.data().moodData) {
        moodHandler.showHistory(docSnap.data().moodData);
      }
    });

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
    elements.addNote.addEventListener('click', () => notesHandler.add());
    elements.clearNotes.addEventListener('click', () => notesHandler.clear());
    elements.addAchievement.addEventListener('click', () => achievementsHandler.add());
    elements.cozyMode.addEventListener('click', toggleCozyMode);
    elements.logout.addEventListener('click', () => {
      localStorage.removeItem('currentUser');
      window.location.href = 'index.html';
    });

    elements.moodTracker.addEventListener('click', (e) => {
      if (e.target.tagName === 'BUTTON') {
        const mood = e.target.dataset.mood;
        elements.moodQuestion.classList.remove('hidden');
        elements.moodReason.placeholder = config.moodQuestions[mood];
        elements.moodQuestion.dataset.currentMood = mood;
      }
    });

    elements.saveMoodReason.addEventListener('click', async () => {
      const mood = elements.moodQuestion.dataset.currentMood;
      const reason = elements.moodReason.value.trim();
      if (!reason) return alert("–ù–∞–ø–∏—à–∏—Ç–µ –ø—Ä–∏—á–∏–Ω—É");
      await moodHandler.save(mood, reason);
      elements.moodReason.value = '';
      elements.moodQuestion.classList.add('hidden');
      moodHandler.showAdvice(mood);
    });
  </script>
</body>
</html>
