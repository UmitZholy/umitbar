<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>–õ–∏—á–Ω—ã–π —É–≥–æ–ª–æ–∫</title>
  <style>
    * {
      box-sizing: border-box;
    }
    html, body {
      margin: 0;
      padding: 0;
      width: 100%;
      height: 100%;
      background-color: #f2f2f2;
      font-family: 'Segoe UI', sans-serif;
      color: #333;
      overflow-x: hidden;
    }
    .container {
      display: flex;
      flex-direction: row;
      min-height: 100vh;
      flex-wrap: wrap;
    }
    .main {
      flex: 2;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 40px;
      background-color: #ffffff;
      width: 100%;
    }
    .main h1 {
      font-size: 2.4em;
      color: #2b2d42;
      margin: 0;
      text-align: center;
    }
    .welcome {
      font-size: 1.2em;
      margin-bottom: 30px;
      color: #555;
      text-align: center;
    }
    .main p {
      font-size: 18px;
      max-width: 600px;
      text-align: center;
      margin-top: 0;
      line-height: 1.6;
    }
    .sidebar {
      flex: 1;
      padding: 30px;
      background-color: #f9f9f9;
      border-left: 2px solid #ddd;
      display: flex;
      flex-direction: column;
      width: 100%;
    }
    .sidebar h2 {
      margin-top: 0;
      color: #2b2d42;
    }
    #noteInput {
      width: 100%;
      height: 80px;
      margin-bottom: 10px;
      padding: 10px;
      border-radius: 8px;
      border: 1px solid #ccc;
      font-size: 15px;
    }
    #addNote {
      padding: 10px;
      background-color: #8ecae6;
      color: white;
      border: none;
      border-radius: 8px;
      font-weight: bold;
      cursor: pointer;
    }
    #addNote:hover {
      background-color: #6bbbd7;
    }
    .note {
      background-color: #ffffff;
      border: 1px solid #ccc;
      border-radius: 8px;
      padding: 10px;
      margin: 8px 0;
      font-size: 14px;
      position: relative;
    }
    .note button {
      position: absolute;
      top: 5px;
      right: 8px;
      background: none;
      border: none;
      color: #888;
      cursor: pointer;
      font-weight: bold;
    }
    #clearNotes {
      margin-top: 10px;
      padding: 8px;
      background-color: #e57373;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: bold;
    }
    #clearNotes:hover {
      background-color: #d45555;
    }
    #logout {
      margin-top: auto;
      padding: 10px;
      background-color: #ffa500;
      border: none;
      border-radius: 8px;
      color: white;
      font-weight: bold;
      cursor: pointer;
      transition: background-color 0.3s ease;
    }
    #logout:hover {
      background-color: #cc8400;
    }
    .instagram-link {
      margin-top: auto;
      padding-top: 30px;
      text-align: center;
      font-size: 14px;
      color: #666;
    }
    .instagram-link a {
      color: #4a90e2;
      text-decoration: none;
    }
    #cozyMode {
      margin-top: 20px;
      padding: 12px 24px;
      background-color: #a5c4d4;
      color: white;
      border: none;
      border-radius: 8px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }
    /* –ù–æ–≤—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–π */
    .achievements-container {
      margin-top: 15px;
      max-height: 200px;
      overflow-y: auto;
    }
    .achievement {
      background-color: #e8f5e9;
      border-left: 4px solid #4caf50;
      padding: 10px;
      margin: 8px 0;
      border-radius: 0 8px 8px 0;
      position: relative;
      animation: fadeIn 0.5s;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateX(-10px); }
      to { opacity: 1; transform: translateX(0); }
    }
    #achievementInput {
      width: 100%;
      height: 60px;
      margin: 10px 0;
      padding: 10px;
      border-radius: 8px;
      border: 1px solid #ccc;
      font-size: 15px;
    }
    #addAchievement {
      width: 100%;
      padding: 10px;
      background-color: #4caf50;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      margin-bottom: 15px;
    }
    /* –°—Ç–∏–ª–∏ –¥–ª—è —Ç—Ä–µ–∫–µ—Ä–∞ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏—è */
    .mood-tracker {
      margin: 25px 0;
      padding: 15px;
      background-color: rgba(255, 245, 245, 0.7);
      border-radius: 10px;
      text-align: center;
    }
    .mood-options {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin: 15px 0;
    }
    .mood-options button {
      font-size: 24px;
      background: none;
      border: none;
      cursor: pointer;
      padding: 10px;
      border-radius: 50%;
      transition: all 0.3s;
    }
    .mood-options button:hover {
      transform: scale(1.2);
      background-color: rgba(0, 0, 0, 0.05);
    }
    .mood-history {
      margin-top: 15px;
      padding: 10px;
      background-color: white;
      border-radius: 8px;
      min-height: 50px;
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 5px;
    }
    .mood-day {
      display: inline-block;
      margin: 5px;
      font-size: 18px;
      opacity: 0.8;
      cursor: pointer;
    }
    .mood-date {
      font-size: 12px;
      color: #666;
      display: block;
    }
    .mood-question {
      margin-top: 15px;
      padding: 15px;
      background-color: #fff;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .mood-question textarea {
      width: 100%;
      height: 80px;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 8px;
      margin-bottom: 10px;
      resize: none;
    }
    #saveMoodReason {
      padding: 8px 15px;
      background-color: #8e44ad;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
    }
    .hidden {
      display: none;
    }
    /* –°—Ç–∏–ª–∏ –¥–ª—è —Å–æ–≤–µ—Ç–æ–≤ */
    .mood-advice {
      margin-top: 10px;
      padding: 10px;
      border-radius: 8px;
      font-size: 14px;
    }
    .advice-happy {
      background-color: #e8f5e9;
      border-left: 3px solid #2ecc71;
    }
    .advice-sad {
      background-color: #fce4ec;
      border-left: 3px solid #e91e63;
    }
    .advice-calm {
      background-color: #e3f2fd;
      border-left: 3px solid #3498db;
    }
    .advice-angry {
      background-color: #ffebee;
      border-left: 3px solid #f44336;
    }
    .advice-neutral {
      background-color: #f5f5f5;
      border-left: 3px solid #9e9e9e;
    }
    /* –°—Ç–∏–ª–∏ –¥–ª—è —É—é—Ç–Ω–æ–≥–æ —Ä–µ–∂–∏–º–∞ */
    .cozy-effect {
      position: fixed;
      pointer-events: none;
      z-index: 1000;
    }
    .leaf {
      position: absolute;
      font-size: 24px;
      animation: float 10s linear infinite;
    }
    @keyframes float {
      0% { transform: translateY(0) rotate(0deg); opacity: 0; }
      10% { opacity: 1; }
      90% { opacity: 1; }
      100% { transform: translateY(-100vh) rotate(360deg); opacity: 0; }
    }
    @media (min-width: 768px) {
      .main {
        width: 66%;
      }
      .sidebar {
        width: 34%;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="main">
      <h1>–õ–∏—á–Ω—ã–π —É–≥–æ–ª–æ–∫ üå§</h1>
      <div class="welcome" id="welcomeMessage"></div>
      <p>–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å. –ó–¥–µ—Å—å –º–æ–∂–Ω–æ –ø—Ä–æ—Å—Ç–æ –±—ã—Ç—å.<br><br>
        –ò–Ω–æ–≥–¥–∞, —á—Ç–æ–±—ã –¥–≤–∏–≥–∞—Ç—å—Å—è –¥–∞–ª—å—à–µ, –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å—Å—è –Ω–∞ –º–≥–Ω–æ–≤–µ–Ω–∏–µ, –≤–¥–æ—Ö–Ω—É—Ç—å –≥–ª—É–±–∂–µ –∏ –Ω–∞–ø–æ–º–Ω–∏—Ç—å —Å–µ–±–µ, –∫—Ç–æ —Ç—ã –µ—Å—Ç—å.
      </p>
      
      <!-- –¢—Ä–µ–∫–µ—Ä –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏—è -->
      <div class="mood-tracker">
        <h3> –ö–∞–∫–æ–µ —É —Ç–µ–±—è –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ —Å–µ–≥–æ–¥–Ω—è?</h3>
        <div class="mood-options">
          <button data-mood="happy" title="–û—Ç–ª–∏—á–Ω–æ!">üòä</button>
          <button data-mood="calm" title="–°–ø–æ–∫–æ–π–Ω–æ">üòå</button>
          <button data-mood="neutral" title="–ù–µ–π—Ç—Ä–∞–ª—å–Ω–æ">üòê</button>
          <button data-mood="sad" title="–ì—Ä—É—Å—Ç–Ω–æ">üòî</button>
          <button data-mood="angry" title="–†–∞–∑–¥—Ä–∞–∂—ë–Ω">üò†</button>
        </div>
        <div id="moodQuestion" class="mood-question hidden">
          <textarea id="moodReason" placeholder="–†–∞—Å—Å–∫–∞–∂–∏ –ø–æ–¥—Ä–æ–±–Ω–µ–µ..."></textarea>
          <button id="saveMoodReason">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        </div>
        <div id="moodHistory" class="mood-history"></div>
      </div>
      
      <button id="cozyMode">üåø –í–∫–ª—é—á–∏—Ç—å —É—é—Ç–Ω—ã–π —Ä–µ–∂–∏–º</button>
    </div>
    <div class="sidebar">
      <h2>–¢–≤–æ–∏ –∑–∞–º–µ—Ç–∫–∏</h2>
      <textarea id="noteInput" placeholder="–ù–∞–ø–∏—à–∏ –Ω–æ–≤—É—é –∑–∞–º–µ—Ç–∫—É..."></textarea>
      <button id="addNote">‚ûï –î–æ–±–∞–≤–∏—Ç—å</button>
      <div id="notesList"></div>
      <button id="clearNotes">üóë –û—á–∏—Å—Ç–∏—Ç—å –≤—Å—ë</button>
      
      <!-- –î–Ω–µ–≤–Ω–∏–∫ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–π -->
      <h2>üìù –ú–æ–π –¥–Ω–µ–≤–Ω–∏–∫ –ø–æ–±–µ–¥</h2>
      <textarea id="achievementInput" placeholder="–ß—Ç–æ —Ö–æ—Ä–æ—à–µ–≥–æ –ø—Ä–æ–∏–∑–æ—à–ª–æ —Å–µ–≥–æ–¥–Ω—è? –î–∞–∂–µ –º–µ–ª–æ—á—å –∏–º–µ–µ—Ç –∑–Ω–∞—á–µ–Ω–∏–µ!"></textarea>
      <button id="addAchievement">‚ú® –ó–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞—Ç—å –ø–æ–±–µ–¥—É</button>
      <div id="achievementsList" class="achievements-container"></div>
      
      <button id="logout">üö™ –í—ã–π—Ç–∏</button>
      <div class="instagram-link">
        –ï—Å—Ç—å –∏–¥–µ–∏, –º—ã—Å–ª–∏ –∫–∞–∫ —É–ª—É—á—à–∏—Ç—å —Å–∞–π—Ç? –ù–∞–ø–∏—à–∏—Ç–µ –Ω–∞–º –≤ Instagram: <a href="https://instagram.com/um1tbar" target="_blank">@um1tbar</a>
      </div>
    </div>
  </div>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import { getFirestore, doc, getDoc, setDoc, updateDoc } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBswC85ThRbIW5wDQOHubt-XHR7SDZJ2Ug",
      authDomain: "umitbar-db.firebaseapp.com",
      projectId: "umitbar-db",
      storageBucket: "umitbar-db.appspot.com",
      messagingSenderId: "114233176038",
      appId: "1:114233176038:web:99edd2a497ca1b39a4b027"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const welcomeMessage = document.getElementById('welcomeMessage');
    const noteInput = document.getElementById('noteInput');
    const addNoteBtn = document.getElementById('addNote');
    const notesList = document.getElementById('notesList');
    const clearBtn = document.getElementById('clearNotes');
    const logoutBtn = document.getElementById('logout');
    const cozyModeBtn = document.getElementById('cozyMode');
    const achievementInput = document.getElementById('achievementInput');
    const addAchievementBtn = document.getElementById('addAchievement');
    const achievementsList = document.getElementById('achievementsList');
    const moodTracker = document.querySelector('.mood-options');
    const moodQuestion = document.getElementById('moodQuestion');
    const moodReason = document.getElementById('moodReason');
    const saveMoodReasonBtn = document.getElementById('saveMoodReason');
    const moodHistory = document.getElementById('moodHistory');

    let currentUser = localStorage.getItem('currentUser');
    if (!currentUser) {
      window.location.href = 'index.html';
    }

    welcomeMessage.textContent = `–ü—Ä–∏–≤–µ—Ç, ${currentUser}!`;

    const userDocRef = doc(db, "users", currentUser);

    // –≠–º–æ–¥–∑–∏ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤ –∏—Å—Ç–æ—Ä–∏–∏
    const moodIcons = {
        happy: 'üòä',
        calm: 'üòå',
        neutral: 'üòê',
        sad: 'üòî',
        angry: 'üò†'
    };

    // –í–æ–ø—Ä–æ—Å—ã –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏—è
    const moodQuestions = {
        happy: "–ß—Ç–æ —Å–µ–≥–æ–¥–Ω—è –ø—Ä–æ–∏–∑–æ—à–ª–æ —Ö–æ—Ä–æ—à–µ–≥–æ? –ü–æ–¥–µ–ª–∏—Å—å —Ä–∞–¥–æ—Å—Ç—å—é!",
        calm: "–ß—Ç–æ –ø–æ–º–æ–≥–ª–æ —Ç–µ–±–µ —á—É–≤—Å—Ç–≤–æ–≤–∞—Ç—å —Å–µ–±—è —Å–ø–æ–∫–æ–π–Ω–æ?",
        neutral: "–û —á–µ–º —Ç—ã –¥—É–º–∞–µ—à—å —Å–µ–≥–æ–¥–Ω—è?",
        sad: "–ß—Ç–æ —Ç–µ–±—è –æ–≥–æ—Ä—á–∞–µ—Ç? –ú–æ–∂–µ—à—å –≤—ã–≥–æ–≤–æ—Ä–∏—Ç—å—Å—è...",
        angry: "–ß—Ç–æ –≤—ã–∑–≤–∞–ª–æ —Ä–∞–∑–¥—Ä–∞–∂–µ–Ω–∏–µ? –ü—Ä–æ–≥–æ–≤–æ—Ä–∏ —ç—Ç–æ ‚Äî —Å—Ç–∞–Ω–µ—Ç –ª–µ–≥—á–µ."
    };

    // –°–æ–≤–µ—Ç—ã –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏—è
    const moodAdvice = {
        happy: "–ó–∞–ø–æ–º–Ω–∏ —ç—Ç–æ—Ç –º–æ–º–µ–Ω—Ç ‚Äî –æ–Ω –ø–æ–º–æ–∂–µ—Ç –≤ —Ç—Ä—É–¥–Ω—ã–π –¥–µ–Ω—å. –ú–æ–∂–µ—à—å –∑–∞–ø–∏—Å–∞—Ç—å –µ–≥–æ –≤ ¬´–î–Ω–µ–≤–Ω–∏–∫ –ø–æ–±–µ–¥¬ª!",
        calm: "–¢–∞–∫–∏–µ –º–æ–º–µ–Ω—Ç—ã ‚Äî –∫–∞–∫ –≥–ª–æ—Ç–æ–∫ –≤–æ–∑–¥—É—Ö–∞. –¶–µ–Ω–∏ –∏—Ö!",
        neutral: "–ò–Ω–æ–≥–¥–∞ ¬´–Ω–µ–π—Ç—Ä–∞–ª—å–Ω–æ¬ª ‚Äî —ç—Ç–æ –ø—Ä–æ—Å—Ç–æ –ø–µ—Ä–µ–¥—ã—à–∫–∞. –ü—Ä–∏—Å–ª—É—à–∞–π—Å—è –∫ —Å–µ–±–µ.",
        sad: "–¢—ã –Ω–µ –æ–¥–∏–Ω. –ò–Ω–æ–≥–¥–∞ –≥—Ä—É—Å—Ç—å ‚Äî —ç—Ç–æ —Å–∏–≥–Ω–∞–ª, —á—Ç–æ –Ω—É–∂–Ω–æ –∑–∞–º–µ–¥–ª–∏—Ç—å—Å—è –∏ –ø–æ–∑–∞–±–æ—Ç–∏—Ç—å—Å—è –æ —Å–µ–±–µ.",
        angry: "–ì–Ω–µ–≤ ‚Äî —ç—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ. –ü–æ–ø—Ä–æ–±—É–π –≥–ª—É–±–æ–∫–æ –≤–¥–æ—Ö–Ω—É—Ç—å 3 —Ä–∞–∑–∞ –∏–ª–∏ –≤—ã–ø–ª–µ—Å–Ω—É—Ç—å —ç–º–æ—Ü–∏–∏ –Ω–∞ –±—É–º–∞–≥—É."
    };

    // –ó–∞–≥—Ä—É–∑–∫–∞ –∑–∞–º–µ—Ç–æ–∫
    async function loadNotes() {
      notesList.innerHTML = '';
      try {
        const docSnap = await getDoc(userDocRef);
        if (docSnap.exists()) {
          const data = docSnap.data();
          const notes = data.notes || [];
          notes.forEach((note, idx) => {
            const div = document.createElement('div');
            div.className = 'note';
            div.textContent = note;
            const btn = document.createElement('button');
            btn.textContent = '√ó';
            btn.title = '–£–¥–∞–ª–∏—Ç—å –∑–∞–º–µ—Ç–∫—É';
            btn.onclick = () => {
              if (confirm("–í—ã —Ç–æ—á–Ω–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç—É –∑–∞–º–µ—Ç–∫—É?")) {
                deleteNote(idx);
              }
            };
            div.appendChild(btn);
            notesList.appendChild(div);
          });
        }
      } catch (e) {
        console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞–º–µ—Ç–æ–∫:", e);
      }
    }

    // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∑–∞–º–µ—Ç–∫–∏
    async function addNote() {
      const value = noteInput.value.trim();
      if (!value) return;

      try {
        const docSnap = await getDoc(userDocRef);
        let notes = [];
        if (docSnap.exists()) {
          notes = docSnap.data().notes || [];
        }

        if (notes.length >= 20) {
          alert("–ú–∞–∫—Å–∏–º—É–º 20 –∑–∞–º–µ—Ç–æ–∫.");
          return;
        }

        notes.push(value);
        await setDoc(userDocRef, { password: docSnap.exists() ? docSnap.data().password : "", notes }, { merge: true });

        noteInput.value = '';
        loadNotes();
      } catch (e) {
        console.error("–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∑–∞–º–µ—Ç–∫–∏:", e);
      }
    }

    // –£–¥–∞–ª–µ–Ω–∏–µ –∑–∞–º–µ—Ç–∫–∏
    async function deleteNote(index) {
      try {
        const docSnap = await getDoc(userDocRef);
        if (!docSnap.exists()) return;

        let notes = docSnap.data().notes || [];
        notes.splice(index, 1);

        await updateDoc(userDocRef, { notes });
        loadNotes();
      } catch (e) {
        console.error("–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –∑–∞–º–µ—Ç–æ–∫:", e);
      }
    }

    // –û—á–∏—Å—Ç–∫–∞ –≤—Å–µ—Ö –∑–∞–º–µ—Ç–æ–∫
    async function clearAllNotes() {
      if (confirm("–û—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ –∑–∞–º–µ—Ç–∫–∏?")) {
        try {
          await updateDoc(userDocRef, { notes: [] });
          loadNotes();
        } catch (e) {
          console.error("–û—à–∏–±–∫–∞ –æ—á–∏—Å—Ç–∫–∏ –∑–∞–º–µ—Ç–æ–∫:", e);
        }
      }
    }

    // –í—ã—Ö–æ–¥
    function logout() {
      localStorage.removeItem('currentUser');
      window.location.href = 'index.html';
    }

    // –£—é—Ç–Ω—ã–π —Ä–µ–∂–∏–º
    let isCozyMode = localStorage.getItem('cozyMode') === 'true';

    function toggleCozyMode() {
        isCozyMode = !isCozyMode;
        localStorage.setItem('cozyMode', isCozyMode);
        
        if (isCozyMode) {
            // –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º —É—é—Ç–Ω—ã–π —Ä–µ–∂–∏–º
            document.body.style.backgroundColor = '#f5efe6';
            document.querySelector('.main').style.backgroundColor = '#f8f4ea';
            document.querySelector('.sidebar').style.backgroundColor = '#f0e9dd';
            document.querySelector('.sidebar').style.borderLeft = '2px solid #e0d6c2';
            cozyModeBtn.textContent = 'üåô –£—é—Ç–Ω—ã–π —Ä–µ–∂–∏–º –≤–∫–ª—é—á–µ–Ω';
            cozyModeBtn.style.backgroundColor = '#c9b8a0';
            
            // –î–æ–±–∞–≤–ª—è–µ–º –ø–∞–¥–∞—é—â–∏–µ –ª–∏—Å—Ç—å—è
            addFallingElements();
        } else {
            // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –æ–±—ã—á–Ω—ã–π —Ä–µ–∂–∏–º
            document.body.style.backgroundColor = '#f2f2f2';
            document.querySelector('.main').style.backgroundColor = '#ffffff';
            document.querySelector('.sidebar').style.backgroundColor = '#f9f9f9';
            document.querySelector('.sidebar').style.borderLeft = '2px solid #ddd';
            cozyModeBtn.textContent = 'üåø –í–∫–ª—é—á–∏—Ç—å —É—é—Ç–Ω—ã–π —Ä–µ–∂–∏–º';
            cozyModeBtn.style.backgroundColor = '#a5c4d4';
            
            // –£–¥–∞–ª—è–µ–º –≤—Å–µ —ç–ª–µ–º–µ–Ω—Ç—ã —É—é—Ç–∞
            document.querySelectorAll('.cozy-effect').forEach(el => el.remove());
        }
    }

    function addFallingElements() {
        const cozyElements = `
            <style>
                .cozy-effect {
                    position: fixed;
                    pointer-events: none;
                    z-index: 1000;
                }
                .leaf {
                    position: absolute;
                    font-size: 24px;
                    animation: float 10s linear infinite;
                }
                @keyframes float {
                    0% { transform: translateY(0) rotate(0deg); opacity: 0; }
                    10% { opacity: 1; }
                    90% { opacity: 1; }
                    100% { transform: translateY(-100vh) rotate(360deg); opacity: 0; }
                }
            </style>
        `;
        document.head.insertAdjacentHTML('beforeend', cozyElements);
        
        // –°–æ–∑–¥–∞–µ–º 15 –ø–∞–¥–∞—é—â–∏—Ö –ª–∏—Å—Ç—å–µ–≤
        for (let i = 0; i < 15; i++) {
            setTimeout(() => {
                const leaf = document.createElement('div');
                leaf.className = 'cozy-effect leaf';
                leaf.innerHTML = 'üçÇ';
                leaf.style.left = Math.random() * 100 + 'vw';
                leaf.style.animationDuration = (5 + Math.random() * 10) + 's';
                leaf.style.animationDelay = Math.random() * 5 + 's';
                document.body.appendChild(leaf);
                
                // –£–¥–∞–ª–µ–Ω–∏–µ –ª–∏—Å—Ç–∞ –ø–æ—Å–ª–µ –∞–Ω–∏–º–∞—Ü–∏–∏
                setTimeout(() => {
                    leaf.remove();
                }, 15000);
            }, i * 300);
        }
    }

    // –î–Ω–µ–≤–Ω–∏–∫ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–π
    async function addAchievement() {
        const text = achievementInput.value.trim();
        if (!text) return;

        try {
            const docSnap = await getDoc(userDocRef);
            let achievements = docSnap.exists() ? docSnap.data().achievements || [] : [];
            
            achievements.unshift({ 
                text: text, 
                date: new Date().toLocaleDateString() 
            });

            await setDoc(userDocRef, { achievements }, { merge: true });
            achievementInput.value = '';
            loadAchievements();
        } catch (e) {
            console.error("–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è:", e);
        }
    }

    async function loadAchievements() {
        achievementsList.innerHTML = '';
        try {
            const docSnap = await getDoc(userDocRef);
            if (docSnap.exists() && docSnap.data().achievements) {
                docSnap.data().achievements.forEach((item, idx) => {
                    const div = document.createElement('div');
                    div.className = 'achievement';
                    div.innerHTML = `
                        <strong>${item.date}</strong><br>
                        ${item.text}
                        <button class="delete-achievement" data-idx="${idx}">√ó</button>
                    `;
                    achievementsList.appendChild(div);
                });
            }
        } catch (e) {
            console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–π:", e);
        }
    }

    // –£–¥–∞–ª–µ–Ω–∏–µ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è
    achievementsList.addEventListener('click', async (e) => {
        if (e.target.classList.contains('delete-achievement')) {
            const idx = e.target.dataset.idx;
            if (confirm("–£–¥–∞–ª–∏—Ç—å —ç—Ç—É –∑–∞–ø–∏—Å—å?")) {
                const docSnap = await getDoc(userDocRef);
                let achievements = docSnap.data().achievements;
                achievements.splice(idx, 1);
                await updateDoc(userDocRef, { achievements });
                loadAchievements();
            }
        }
    });

    // –¢—Ä–µ–∫–µ—Ä –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏—è
    moodTracker.addEventListener('click', async (e) => {
        if (e.target.tagName === 'BUTTON') {
            const mood = e.target.dataset.mood;
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≤–æ–ø—Ä–æ—Å
            moodQuestion.classList.remove('hidden');
            moodQuestion.querySelector('textarea').placeholder = moodQuestions[mood];
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤—ã–±—Ä–∞–Ω–Ω–æ–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ –¥–ª—è –ø–æ—Å–ª–µ–¥—É—é—â–µ–≥–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
            moodQuestion.dataset.currentMood = mood;
        }
    });

    // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø—Ä–∏—á–∏–Ω—ã –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏—è
    saveMoodReasonBtn.addEventListener('click', async () => {
        const mood = moodQuestion.dataset.currentMood;
        const reason = moodReason.value.trim();
        const today = new Date().toLocaleDateString();
        
        if (!reason) {
            alert("–ù–∞–ø–∏—à–∏ —Ö–æ—Ç—è –±—ã –ø–∞—Ä—É —Å–ª–æ–≤!");
            return;
        }

        try {
            const docSnap = await getDoc(userDocRef);
            let moodData = docSnap.exists() ? docSnap.data().moodData || {} : {};
            
            // –ó–∞–ø–∏—Å—ã–≤–∞–µ–º –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ + –ø—Ä–∏—á–∏–Ω—É
            moodData[today] = { 
                mood: mood, 
                reason: reason 
            };
            
            await updateDoc(userDocRef, { moodData });
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–≤–µ—Ç –∏ –∏—Å—Ç–æ—Ä–∏—é
            showMoodAdvice(mood);
            showMoodHistory(moodData);
            
            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–æ—Ä–º—É
            moodReason.value = '';
            moodQuestion.classList.add('hidden');
        } catch (e) {
            console.error("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è:", e);
        }
    });

    // –ü–æ–∫–∞–∑ —Å–æ–≤–µ—Ç–∞
    function showMoodAdvice(mood) {
        const adviceBox = document.createElement('div');
        adviceBox.className = `mood-advice advice-${mood}`;
        adviceBox.textContent = moodAdvice[mood];
        
        // –£–¥–∞–ª—è–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π —Å–æ–≤–µ—Ç, –µ—Å–ª–∏ –µ—Å—Ç—å
        const oldAdvice = document.querySelector('.mood-advice');
        if (oldAdvice) oldAdvice.remove();
        
        moodQuestion.insertAdjacentElement('afterend', adviceBox);
    }

    // –ü–æ–∫–∞–∑ –∏—Å—Ç–æ—Ä–∏–∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–π
    async function showMoodHistory(moodData) {
        const dates = Object.keys(moodData).sort().reverse().slice(0, 7);
        moodHistory.innerHTML = dates.map(date => {
            const entry = moodData[date];
            return `
                <div class="mood-day" title="${date}: ${entry.reason || '–ù–µ—Ç –æ–ø–∏—Å–∞–Ω–∏—è'}">
                    ${moodIcons[entry.mood]} 
                    <span class="mood-date">${date}</span>
                </div>
            `;
        }).join('');
    }

    // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    window.addEventListener('load', async () => {
        loadNotes();
        loadAchievements();
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º —É—é—Ç–Ω—ã–π —Ä–µ–∂–∏–º
        if (isCozyMode) {
            toggleCozyMode();
        }
        
        // –ó–∞–≥—Ä—É–∂–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–π
        const docSnap = await getDoc(userDocRef);
        if (docSnap.exists() && docSnap.data().moodData) {
            showMoodHistory(docSnap.data().moodData);
        }
    });

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
    addNoteBtn.addEventListener('click', addNote);
    clearBtn.addEventListener('click', clearAllNotes);
    logoutBtn.addEventListener('click', logout);
    cozyModeBtn.addEventListener('click', toggleCozyMode);
    addAchievementBtn.addEventListener('click', addAchievement);
  </script>
</body>
</html>
